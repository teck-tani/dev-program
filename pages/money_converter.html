<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#74ebd5">
    <title>환율계산기 | Tani DevTool</title>
    <meta name="description" content="실시간 환율로 통화를 쉽게 변환할 수 있는 무료 온라인 환율계산기입니다.">
    <link rel="stylesheet" href="../css/style.css">
    <script src="../js/common.js"></script>
    <style>
        .currency-form {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .currency-rows {
            margin-bottom: 20px;
        }
        .currency-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .currency-select {
            flex: 0 0 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .currency-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
        }
        .error-message {
            color: red;
            margin: 10px 0;
        }
        .update-time {
            margin-top: 20px;
            text-align: right;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="top-container"></div>

    <div class="container">
        <h1>환율계산기</h1>
        <p>실시간 환율로 통화를 쉽게 변환할 수 있는 무료 온라인 환율계산기입니다. 아래 금액을 수정하면 자동으로 다른 통화의 금액이 업데이트됩니다.</p>
        
        <div class="currency-form">
            <div id="loading" class="loading">환율 정보를 가져오는 중...</div>
            <div id="error-message" class="error-message"></div>
            <div id="currency-rows" class="currency-rows"></div>
            <div id="update-time" class="update-time"></div>
        </div>
    </div>

    <div id="footer-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currencyRowsDiv = document.getElementById('currency-rows');
            const loadingDiv = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('error-message');
            const updateTimeDiv = document.getElementById('update-time');

            // 초기 통화 설정 (5개 행)
            const defaultCurrencies = ['KRW', 'USD', 'EUR', 'JPY', 'CNY'];
            
            // 보여줄 통화 리스트
            const availableCurrencies = [
                'KRW', 'USD', 'EUR', 'JPY', 'CNY', 'GBP', 'CAD', 'AUD', 'HKD', 'SGD', 'THB'
            ];
            
            // 통화 이름
            const currencyNames = {
                'KRW': '한국 원화',
                'USD': '미국 달러',
                'EUR': '유로',
                'JPY': '일본 엔',
                'CNY': '중국 위안',
                'GBP': '영국 파운드',
                'CAD': '캐나다 달러',
                'AUD': '호주 달러',
                'HKD': '홍콩 달러',
                'SGD': '싱가포르 달러',
                'THB': '태국 바트'
            };

            // 통화 변환에 사용될 환율 정보 저장 객체
            let exchangeRates = {};
            let lastUpdated = null;

            // 모든 통화 선택 요소와 입력 요소를 저장하는 배열
            const currencyElements = [];

            // 초기 행 생성
            function createCurrencyRows() {
                currencyRowsDiv.innerHTML = '';
                defaultCurrencies.forEach((currency, index) => {
                    const row = document.createElement('div');
                    row.className = 'currency-row';
                    
                    // 통화 선택 드롭다운
                    const select = document.createElement('select');
                    select.className = 'currency-select';
                    select.id = `currency-select-${index}`;
                    
                    availableCurrencies.forEach(curr => {
                        const option = document.createElement('option');
                        option.value = curr;
                        option.textContent = `${currencyNames[curr]} (${curr})`;
                        option.selected = curr === currency;
                        select.appendChild(option);
                    });
                    
                    // 입력 필드
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'currency-input';
                    input.id = `currency-input-${index}`;
                    input.placeholder = '금액 입력';
                    input.value = index === 0 ? '1000' : ''; // 첫 번째 행에 기본값 설정
                    
                    row.appendChild(select);
                    row.appendChild(input);
                    currencyRowsDiv.appendChild(row);
                    
                    // 요소 저장
                    currencyElements.push({
                        select: select,
                        input: input,
                        index: index
                    });
                    
                    // 이벤트 리스너 추가
                    select.addEventListener('change', () => {
                        loadExchangeRates();
                    });
                    
                    input.addEventListener('input', function() {
                        convertFromInput(this, index);
                    });
                });
            }

            // 환율 정보 로드
            function loadExchangeRates() {
                // 현재 선택된 모든 통화 코드 가져오기
                const selectedCurrencies = currencyElements.map(el => el.select.value);
                
                // 중복 통화 확인
                const uniqueCurrencies = [...new Set(selectedCurrencies)];
                if (uniqueCurrencies.length !== selectedCurrencies.length) {
                    errorMessageDiv.textContent = '동일한 통화가 여러 개 선택되었습니다. 각 행에 서로 다른 통화를 선택해주세요.';
                    return;
                }
                
                errorMessageDiv.textContent = '';
                loadingDiv.style.display = 'block';
                
                // 기준 통화로 첫 번째 행의 통화 사용
                const baseCurrency = selectedCurrencies[0];
                
                // API 호출
                fetch(`https://api.exchangerate-api.com/v4/latest/${baseCurrency}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('환율 정보를 가져오는데 실패했습니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingDiv.style.display = 'none';
                        
                        // 환율 정보 저장
                        exchangeRates = data.rates;
                        lastUpdated = new Date(data.time_last_updated * 1000);
                        
                        // 업데이트 시간 표시
                        updateTimeDiv.textContent = `마지막 업데이트: ${lastUpdated.toLocaleDateString('ko-KR')} ${lastUpdated.toLocaleTimeString('ko-KR')}`;
                        
                        // 입력값 있는 경우 변환 실행
                        for (let i = 0; i < currencyElements.length; i++) {
                            if (currencyElements[i].input.value) {
                                convertFromInput(currencyElements[i].input, i);
                                break;
                            }
                        }
                        
                        // 입력값 없으면 첫 번째 입력에 기본값 설정
                        if (!currencyElements.some(el => el.input.value)) {
                            currencyElements[0].input.value = '1000';
                            convertFromInput(currencyElements[0].input, 0);
                        }
                    })
                    .catch(error => {
                        loadingDiv.style.display = 'none';
                        errorMessageDiv.textContent = error.message;
                        console.error('Error:', error);
                    });
            }

            // 입력값 기준으로 다른 통화 변환
            function convertFromInput(inputElement, sourceIndex) {
                if (Object.keys(exchangeRates).length === 0) {
                    return; // 환율 정보가 없으면 변환 안함
                }
                
                const amount = parseFloat(inputElement.value) || 0;
                if (amount <= 0) {
                    return;
                }
                
                const sourceCurrency = currencyElements[sourceIndex].select.value;
                
                // 모든 행에 대해 변환
                currencyElements.forEach((el, index) => {
                    if (index !== sourceIndex) { // 입력한 행 제외
                        const targetCurrency = el.select.value;
                        
                        // 같은 통화면 같은 값
                        if (targetCurrency === sourceCurrency) {
                            el.input.value = amount.toString();
                            return;
                        }
                        
                        // 환율 계산
                        let convertedAmount;
                        if (sourceCurrency === currencyElements[0].select.value) {
                            // 기준 통화에서 변환
                            convertedAmount = amount * exchangeRates[targetCurrency];
                        } else if (targetCurrency === currencyElements[0].select.value) {
                            // 기준 통화로 변환
                            convertedAmount = amount / exchangeRates[sourceCurrency];
                        } else {
                            // 다른 통화끼리 변환 (기준 통화 경유)
                            const rateToBase = 1 / exchangeRates[sourceCurrency];
                            const rateFromBase = exchangeRates[targetCurrency];
                            convertedAmount = amount * rateToBase * rateFromBase;
                        }
                        
                        // 소수점 처리 (JPY는 정수로, 다른 통화는 소수점 2자리)
                        if (targetCurrency === 'JPY') {
                            el.input.value = Math.round(convertedAmount);
                        } else {
                            el.input.value = convertedAmount.toFixed(2);
                        }
                    }
                });
            }

            // 초기화 및 환율 정보 로드
            createCurrencyRows();
            loadExchangeRates();
        });
    </script>
</body>
</html>