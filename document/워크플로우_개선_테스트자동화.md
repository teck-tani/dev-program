# 워크플로우 개선: 테스트 자동화 도입

## Context

현재 워크플로우: `코드 수정 → 배포 → 폰으로 직접 확인 → 버그 발견 → 다시 수정`
문제: 수동 테스트가 느리고, 다크모드/번역/모바일 레이아웃 버그가 반복적으로 발생

**현재 프로젝트 테스트 인프라: 제로**
- 테스트 파일 0개, CI/CD 없음, pre-commit 훅 없음
- Playwright v1.58.2 설치되어 있지만 미사용
- ESLint + TypeScript strict만 존재

**반복되는 3대 버그 유형:**
1. 다크모드 스타일 누락 (가장 빈번)
2. 번역 키 불일치 (ko.json ↔ en.json 6개 키 현재 불일치)
3. 모바일 레이아웃 깨짐 (가로 스크롤, 넘침)

**목표 워크플로우:**
```
코드 수정 → 자동 체크가 80% 버그 포착 → 수동은 인터랙션/오디오만 확인
```

---

## Phase 1: 유효성 검사 스크립트 (~30분)

### 1A. 번역 키 동기화 검사기
- **생성**: `scripts/check-translations.mjs`
- ko.json과 en.json의 모든 leaf 키를 비교하여 누락된 키 보고
- en.json에 한국어가 섞여 있으면 경고 (복붙 실수 감지)
- `tools.ts`의 `ALL_TOOLS` labelKey가 번역 파일에 있는지 교차 검증
- 불일치 시 exit code 1 → CI에서 실패 처리 가능

### 1B. npm 스크립트 추가
- **수정**: `package.json`
```json
"check": "npm run lint && npx tsc --noEmit && node scripts/check-translations.mjs",
"check:visual": "npx playwright test",
"check:visual:update": "npx playwright test --update-snapshots"
```

### 이 단계에서 잡히는 버그:
- 번역 키 누락/불일치 (현재 6건 감지됨)
- en.json에 한국어 텍스트 잔류
- TypeScript 타입 에러
- ESLint 위반

---

## Phase 2: Playwright 시각 회귀 테스트 (~2시간)

### 2A. Playwright 설정
- `playwright` → `@playwright/test`로 교체
- **생성**: `playwright.config.ts`
- 4가지 뷰포트 프로젝트:
  - `mobile-light` (iPhone 14)
  - `mobile-dark` (iPhone 14 + dark theme)
  - `desktop-light` (1280x800)
  - `desktop-dark` (1280x800 + dark theme)
- 다크모드 주의: 이 프로젝트는 `body[data-theme="dark"]` 사용 → `colorScheme`이 아닌 localStorage + body attribute 직접 설정 필요

### 2B. 시각 회귀 테스트
- **생성**: `tests/e2e/visual-regression.spec.ts`
- `src/config/tools.ts`의 `ALL_TOOLS` 배열에서 URL 목록 추출
- 각 도구 페이지를 4가지 상태(모바일 라이트/다크, 데스크톱 라이트/다크)로 스크린샷
- `toHaveScreenshot()`으로 이전 스냅샷과 비교
- 동적 콘텐츠(시계, 광고, 환율) 마스킹 처리
- 51개 도구 × 4상태 = 204장 스크린샷 (스냅샷 폴더는 .gitignore)

### 2C. 실전 사용법
```bash
# 내가 수정한 도구만 빠르게 (가장 버그 많은 모바일 다크만)
npx playwright test --grep "timer" --project=mobile-dark

# 배포 전 전체 검사
npm run check:visual
```

### 이 단계에서 잡히는 버그:
- 다크모드 스타일 누락 (텍스트 안 보임, 배경색 안 바뀜)
- 모바일 레이아웃 깨짐 (넘침, 짤림, 가로 스크롤)
- 데스크톱 레이아웃 이상
- CSS 회귀 (기존 스타일 깨짐)

---

## Phase 3: GitHub Actions CI (~20분)

### 3A. CI 워크플로우
- **생성**: `.github/workflows/ci.yml`
- **`lint-and-check` 잡** (매 push, ~2분):
  - TypeScript 체크
  - ESLint
  - 번역 키 동기화
  - 빌드 확인
- **`visual-regression` 잡** (PR만, ~8분):
  - mobile-dark + desktop-light 2개 프로젝트만 (가장 많은 버그 포착)
  - 실패 시 스크린샷 diff를 아티팩트로 업로드

---

## Phase 4: Pre-commit 훅 (Phase 1-2 안정화 후)

- husky + lint-staged 설치
- `.ts/.tsx` 파일 변경 시 → ESLint 자동 수정
- `messages/*.json` 변경 시 → 번역 키 동기화 검사
- 커밋 전 2초만에 기본 검증 완료

---

## 수정 대상 파일

| 파일 | 작업 |
|------|------|
| `scripts/check-translations.mjs` | **신규** - 번역 키 검사 스크립트 |
| `package.json` | **수정** - 스크립트 추가, playwright 교체 |
| `playwright.config.ts` | **신규** - Playwright 설정 |
| `tests/e2e/visual-regression.spec.ts` | **신규** - 시각 회귀 테스트 |
| `tests/e2e/helpers/theme.ts` | **신규** - 다크모드 설정 헬퍼 |
| `.github/workflows/ci.yml` | **신규** - CI 파이프라인 |
| `.gitignore` | **수정** - 스냅샷 폴더 제외 추가 |

## 핵심 참조 파일

| 파일 | 용도 |
|------|------|
| `src/config/tools.ts` | ALL_TOOLS 배열 → 테스트할 URL 목록 |
| `messages/ko.json` / `en.json` | 번역 키 비교 대상 (현재 ~5,000키) |
| `src/contexts/ThemeContext.tsx` | 다크모드 메커니즘 (localStorage + body attr) |
| `src/app/globals.css` | 글로벌 다크모드 셀렉터 132개 |

---

## 효과 예측

| 버그 유형 | 현재 | 자동화 후 |
|-----------|------|-----------|
| 번역 키 누락 | 배포 후 발견 | **커밋 전 차단** (Phase 1) |
| 다크모드 누락 | 폰으로 직접 확인 | **PR에서 스크린샷으로 자동 감지** (Phase 2) |
| 모바일 깨짐 | 폰으로 직접 확인 | **PR에서 스크린샷으로 자동 감지** (Phase 2) |
| 빌드 실패 | 배포 후 발견 | **push 시 자동 차단** (Phase 3) |
| 타입 에러 | 에디터에서만 | **CI에서도 차단** (Phase 3) |

**수동 테스트가 여전히 필요한 20%:**
인터랙션 동작, 오디오/진동, 파일 업로드/다운로드, API 의존 기능, 크로스 브라우저 특이 케이스
